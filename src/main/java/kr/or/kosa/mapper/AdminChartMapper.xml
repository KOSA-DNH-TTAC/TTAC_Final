<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.dao.AdminChartDao">

	<!-- 월별 외박횟수 -->
	<select id="adminMonthlySleepover" parameterType="kr.or.kosa.dto.AdminChart" resultType="kr.or.kosa.dto.AdminChart">      
      SELECT 
    YEAR, 
    MONTH, 
    SUM(sleepoverCount) AS sleepoverCount, 
    SUM(longsleepoverCount) AS longsleepoverCount 
FROM 
    (
        SELECT 
            DATE_FORMAT(startdate, '%Y') AS YEAR, 
            DATE_FORMAT(startdate, '%m') AS MONTH, 
            COUNT(*) AS sleepoverCount, 
            0 AS longsleepoverCount
        FROM 
            SLEEPOVERHISTORY
        WHERE 
            DATE_FORMAT(startdate, '%Y')=#{year} 
            AND UNIVERSITYCODE=#{universityCode} 
            AND DOMITORYNAME = #{domitoryName} 
            AND STATUS = 11 
        GROUP BY 
            YEAR, 
            MONTH 
        UNION ALL
        SELECT 
            DATE_FORMAT(startdate, '%Y') AS YEAR, 
            DATE_FORMAT(startdate, '%m') AS MONTH, 
            0 AS sleepoverCount, 
            COUNT(*) AS longsleepoverCount
        FROM 
            SLEEPOVERHISTORY
        WHERE 
            DATE_FORMAT(startdate, '%Y')=#{year} 
            AND UNIVERSITYCODE=#{universityCode} 
            AND DOMITORYNAME = #{domitoryName} 
            AND STATUS = 12 
        GROUP BY 
            YEAR, 
            MONTH 
    ) AS temp
GROUP BY 
    YEAR, 
    MONTH
ORDER BY MONTH;
	</select>
	
	
</mapper>





